<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SimplyDoors Pro Label Maker (Auto-Extract)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/pdfjs-dist@2.16.105/build/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@2.16.105/build/pdf.worker.min.js';
    </script>

    <style>
        /* --- PRINT STYLES (4x6 INCH LABEL) --- */
        @media print {
            @page {
                size: 4in 6in;
                margin: 0;
            }
            body * {
                visibility: hidden;
            }
            .no-print {
                display: none !important;
            }
            #print-area, #print-area * {
                visibility: visible;
            }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            
            /* The Label Container */
            .label-card {
                width: 4in;
                height: 6in;
                position: relative;
                page-break-after: always;
                break-after: page;
                display: flex;
                flex-direction: column;
                background: white;
                padding: 0.2in;
                box-sizing: border-box;
                font-family: Arial, Helvetica, sans-serif;
                color: black;
                overflow: hidden;
                border-bottom: 1px dashed #ccc; /* Helper for cutting if needed */
            }

            /* Header */
            .label-header {
                text-align: center;
                font-size: 20pt;
                font-weight: bold;
                margin-bottom: 5px;
                letter-spacing: -0.5px;
            }

            /* Image Section */
            .label-image {
                height: 1.8in; 
                display: flex;
                justify-content: center;
                align-items: center;
                margin-bottom: 8px;
                border-bottom: 2px solid #000;
                padding-bottom: 5px;
            }
            .label-image img {
                max-height: 100%;
                max-width: 100%;
                object-fit: contain;
            }

            /* Data Section */
            .label-data {
                flex-grow: 1;
                font-size: 8.5pt;
                line-height: 1.3;
            }
            .data-row {
                margin-bottom: 3px;
                display: flex;
            }
            .field-label {
                font-weight: bold;
                width: 75px; /* Fixed width for alignment */
                flex-shrink: 0;
            }
            .field-value {
                font-weight: normal;
            }

            /* Barcode Section */
            .label-footer {
                text-align: center;
                margin-top: auto;
                padding-top: 5px;
            }
            .barcode-svg {
                width: 85%;
                height: 35px;
            }
            .sku-text {
                font-size: 8pt;
                font-weight: bold;
                margin-top: 2px;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-8 font-sans">

    <div class="max-w-5xl mx-auto no-print">
        
        <div class="bg-white rounded-lg shadow-xl p-8 mb-8 border-t-8 border-gray-800">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">SimplyDoors Label Maker</h1>
            <p class="text-gray-600 mb-6">Upload Quote PDF. The app will attempt to <b>auto-detect</b> Job info, or you can type it below.</p>

            <div class="bg-blue-50 p-6 rounded-lg border border-blue-200 mb-6">
                <h3 class="text-blue-800 font-bold mb-3 uppercase text-sm tracking-wide">Job Information (Applied to all labels)</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-700 uppercase mb-1">PO # / Job #</label>
                        <input type="text" id="jobInput" placeholder="Auto-detected..." class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none font-semibold">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Job Name</label>
                        <input type="text" id="jobNameInput" placeholder="Auto-detected..." class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none font-semibold">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Customer</label>
                        <input type="text" id="customerInput" placeholder="Auto-detected..." class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none font-semibold">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Location / Address</label>
                        <input type="text" id="locationInput" placeholder="Auto-detected..." class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none font-semibold">
                    </div>
                </div>
            </div>

            <div class="flex gap-4 items-center">
                <input type="file" id="fileInput" accept=".pdf" class="block w-full text-sm text-gray-500 file:mr-4 file:py-3 file:px-6 file:rounded-full file:border-0 file:text-sm file:font-bold file:bg-gray-100 file:text-gray-700 hover:file:bg-gray-200 cursor-pointer">
                
                <button id="printBtn" onclick="window.print()" class="hidden bg-gray-800 hover:bg-gray-900 text-white font-bold py-3 px-8 rounded-full shadow-lg transition-all flex items-center gap-2">
                    <span>Print Labels</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" /></svg>
                </button>
            </div>
        </div>

        <div id="loading" class="hidden text-center py-10">
            <div class="inline-block animate-spin rounded-full h-10 w-10 border-b-4 border-blue-600 mb-4"></div>
            <p class="text-xl text-gray-600 font-semibold">Analyzing PDF...</p>
        </div>

        <div id="results" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </div>

    <div id="print-area"></div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const resultsDiv = document.getElementById('results');
        const printArea = document.getElementById('print-area');
        const loadingDiv = document.getElementById('loading');
        const printBtn = document.getElementById('printBtn');
        
        // Inputs
        const jobInput = document.getElementById('jobInput');
        const jobNameInput = document.getElementById('jobNameInput');
        const customerInput = document.getElementById('customerInput');
        const locationInput = document.getElementById('locationInput');

        let extractedLabels = [];

        fileInput.addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            // Reset UI
            resultsDiv.innerHTML = '';
            printArea.innerHTML = '';
            extractedLabels = [];
            printBtn.classList.add('hidden');
            loadingDiv.classList.remove('hidden');
            
            // Clear inputs initially
            jobInput.value = '';
            jobNameInput.value = '';
            customerInput.value = '';
            locationInput.value = '';

            try {
                const arrayBuffer = await file.arrayBuffer();
                const loadingTask = pdfjsLib.getDocument({data: arrayBuffer});
                const pdf = await loadingTask.promise;

                // 1. ANALYZE HEADER DATA (from Page 1)
                await extractGlobalData(pdf);

                // 2. EXTRACT LABELS (All Pages)
                for (let i = 1; i <= pdf.numPages; i++) {
                    await processPage(pdf, i);
                }

                // 3. GENERATE
                generateLabels(); 
                printBtn.classList.remove('hidden');

            } catch (err) {
                console.error(err);
                alert("Error: " + err.message);
            } finally {
                loadingDiv.classList.add('hidden');
            }
        });

        // --- NEW: Helper to find Header Data ---
        async function extractGlobalData(pdf) {
            const page = await pdf.getPage(1); // Usually on Page 1
            const textContent = await page.getTextContent();
            const items = textContent.items;

            // Sort Y desc (top to bottom), X asc (left to right)
            items.sort((a, b) => {
                const yDiff = b.transform[5] - a.transform[5];
                if (Math.abs(yDiff) > 5) return yDiff; 
                return a.transform[4] - b.transform[4];
            });

            // Helper to search for value to the right or below a key
            function findValue(keyPatterns) {
                for (let i = 0; i < items.length; i++) {
                    const str = items[i].str.trim();
                    // Check if item matches any key pattern
                    if (keyPatterns.some(k => str.toLowerCase().includes(k.toLowerCase()))) {
                        
                        // Strategy 1: The value is in the same string (e.g., "Name: John Doe")
                        const split = str.split(/:(.+)/);
                        if (split.length > 1 && split[1].trim().length > 1) {
                            return split[1].trim();
                        }

                        // Strategy 2: The value is in the next item
                        if (i + 1 < items.length) {
                            return items[i + 1].str.trim();
                        }
                    }
                }
                return "";
            }

            // Attempt Extraction
            const foundCustomer = findValue(["Name:", "Customer:"]);
            const foundAddress = findValue(["Address:", "Location:"]);
            const foundJobName = findValue(["Job Name:"]);
            const foundPO = findValue(["Quote Number:", "PO Number:", "Job #:", "Quote #:"]);

            // Fill Inputs if found
            if (foundCustomer) customerInput.value = foundCustomer;
            if (foundAddress) locationInput.value = foundAddress;
            if (foundJobName) jobNameInput.value = foundJobName;
            if (foundPO) jobInput.value = foundPO;
        }

        async function processPage(pdf, pageNum) {
            const page = await pdf.getPage(pageNum);
            const scale = 3.0; 
            const viewport = page.getViewport({ scale: scale });
            const textContent = await page.getTextContent();
            let items = textContent.items;

            items.sort((a, b) => {
                const yDiff = b.transform[5] - a.transform[5];
                if (Math.abs(yDiff) > 5) return yDiff; 
                return a.transform[4] - b.transform[4];
            });

            let name = "Unknown Item";
            let pdfY_Top = -1, pdfX_Left = -1, pdfY_Bot = -1, pdfX_Qty = -1, pdfY_Total = -1;
            let commentIndex = -1;

            for (let i = 0; i < items.length; i++) {
                const str = items[i].str.trim();
                const y = items[i].transform[5];
                const x = items[i].transform[4];

                if (str.includes("Comment:")) commentIndex = i;
                if (str.includes("Sales Person")) {
                    if (y > pdfY_Top) pdfY_Top = y;
                    if (pdfX_Left === -1) pdfX_Left = x;
                }
                if (str.includes("Item Description")) pdfY_Bot = y;
                if (str === "Qty") pdfX_Qty = x;
                if (str.includes("Item Total") || str.includes("Order Sub Total")) {
                    if (pdfY_Total === -1) pdfY_Total = y;
                }
            }

            if (pdfY_Top === -1) pdfY_Top = 700;
            if (pdfY_Bot === -1) pdfY_Bot = 150;
            if (pdfX_Left === -1) pdfX_Left = (viewport.width / scale) * 0.35; 
            if (pdfX_Qty === -1) pdfX_Qty = 550; 
            if (pdfY_Total === -1) pdfY_Total = 50;

            // Extract Name
            if (commentIndex !== -1) {
                const commentItem = items[commentIndex];
                const parts = commentItem.str.split("Comment:");
                if (parts.length > 1 && parts[1].trim().length > 0) {
                    name = parts[1].trim();
                } else if (commentIndex + 1 < items.length) {
                    name = items[commentIndex + 1].str.trim();
                }
            }

            // Extract Description
            let descLines = [];
            const descItems = items.filter(item => {
                const y = item.transform[5];
                const x = item.transform[4];
                return (y < pdfY_Bot - 10 && y > pdfY_Total + 10 && x < pdfX_Qty - 20); 
            });

            let currentLineY = -1;
            let currentLineText = [];
            descItems.forEach(item => {
                const str = item.str.trim();
                if (!str) return;
                const y = item.transform[5];
                if (Math.abs(y - currentLineY) < 6) {
                    currentLineText.push(str);
                } else {
                    if (currentLineText.length > 0) descLines.push(currentLineText.join(" "));
                    currentLineY = y;
                    currentLineText = [str];
                }
            });
            if (currentLineText.length > 0) descLines.push(currentLineText.join(" "));
            let descText = descLines.join("\n");
            
            if (name === "Unknown Item" && descText === "") return;

            // Extract Image
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            await page.render({ canvasContext: ctx, viewport: viewport }).promise;

            const topPt = viewport.convertToViewportPoint(0, pdfY_Top);
            const cropY = topPt[1] + 30; 
            const botPt = viewport.convertToViewportPoint(0, pdfY_Bot);
            const cropBottom = botPt[1] - 35; 
            const cropHeight = cropBottom - cropY;
            const leftPt = viewport.convertToViewportPoint(pdfX_Left, 0);
            const cropX = leftPt[0] - 5; 
            const cropWidth = viewport.width - cropX - 20;

            if (cropHeight <= 0 || cropWidth <= 0) return;

            const cropCanvas = document.createElement('canvas');
            cropCanvas.width = cropWidth;
            cropCanvas.height = cropHeight;
            const cropCtx = cropCanvas.getContext('2d');
            cropCtx.fillStyle = '#ffffff';
            cropCtx.fillRect(0, 0, cropWidth, cropHeight);
            cropCtx.drawImage(canvas, cropX, cropY, cropWidth, cropHeight, 0, 0, cropWidth, cropHeight);
            const imgDataUrl = cropCanvas.toDataURL('image/jpeg', 0.9);

            extractedLabels.push({ name: name, img: imgDataUrl, desc: descText });
        }

        function generateLabels() {
            // Get current input values (either auto-detected or user edited)
            const jobNum = jobInput.value || "---";
            const jobName = jobNameInput.value || ""; // Empty string if blank to hide it
            const custName = customerInput.value || "---";
            const locName = locationInput.value || "---";
            
            // Format today's date for SKU like "SD-20231027-"
            const dateStr = new Date().toISOString().slice(0,10).replace(/-/g,"");
            const skuBase = "SD-" + dateStr;

            extractedLabels.forEach((item, index) => {
                const uniqueSKU = `${skuBase}-${index + 1}`;

                // Preview Card
                const previewHTML = `
                <div class="bg-white rounded border border-gray-300 p-4 flex flex-col gap-2">
                    <div class="flex gap-4">
                        <img src="${item.img}" class="w-20 h-20 object-contain border border-gray-200 rounded bg-white">
                        <div class="overflow-hidden">
                            <h3 class="font-bold text-md truncate">${item.name}</h3>
                            <p class="text-xs text-gray-500 font-mono mt-1 line-clamp-3">${item.desc}</p>
                        </div>
                    </div>
                </div>`;
                resultsDiv.insertAdjacentHTML('beforeend', previewHTML);

                // Print Label HTML (4x6 layout)
                const labelHTML = `
                <div class="label-card">
                    <div class="label-header">SimplyDoors</div>

                    <div class="label-image">
                        <img src="${item.img}">
                    </div>

                    <div class="label-data">
                        <div class="data-row">
                            <span class="field-label">Item:</span> 
                            <span class="field-value"><b>${item.name}</b></span>
                        </div>
                        
                        <div class="data-row">
                            <span class="field-label">Details:</span>
                            <span class="field-value" style="font-size: 8pt;">${item.desc.replace(/\n/g, '<br>')}</span>
                        </div>

                        <div class="data-row" style="margin-top:5px;">
                            <span class="field-label">Qty:</span> 
                            <span class="field-value">1.00</span>
                        </div>

                        <div class="data-row">
                            <span class="field-label">Job #:</span> 
                            <span class="field-value">${jobNum}</span>
                        </div>
                        
                        ${ jobName ? `
                        <div class="data-row">
                            <span class="field-label">Job Name:</span> 
                            <span class="field-value">${jobName}</span>
                        </div>` : '' }

                        <div class="data-row">
                            <span class="field-label">Customer:</span> 
                            <span class="field-value">${custName}</span>
                        </div>

                        <div class="data-row">
                            <span class="field-label">Location:</span> 
                            <span class="field-value">${locName}</span>
                        </div>
                    </div>

                    <div class="label-footer">
                        <svg id="barcode-${index}" class="barcode-svg"></svg>
                        <div class="sku-text">SKU:${uniqueSKU}</div>
                    </div>
                </div>
                `;
                printArea.insertAdjacentHTML('beforeend', labelHTML);

                // Generate Barcode
                try {
                    JsBarcode(`#barcode-${index}`, uniqueSKU, {
                        format: "CODE128",
                        lineColor: "#000",
                        width: 2,
                        height: 40,
                        displayValue: false,
                        margin: 0
                    });
                } catch (e) { console.log("Barcode error", e); }
            });
        }
    </script>
</body>
</html>
