<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SimplyDoors Labels</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    </script>

    <style>
        /* --- GLOBAL RESETS --- */
        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; background-color: #525659; overflow: hidden; }

        /* --- SCREEN LAYOUT --- */
        .app-container { display: flex; height: 100vh; width: 100vw; }
        
        /* LEFT PANE: PDF Viewer */
        .left-pane { 
            width: 50%; 
            border-right: 2px solid #333; 
            background: #525659; 
            display: flex; 
            flex-direction: column; 
            overflow-y: auto; 
            align-items: center;
            padding: 20px;
        }
        
        .pdf-canvas {
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            margin-bottom: 20px;
            max-width: 95%;
        }

        /* RIGHT PANE: Controls & Preview */
        .right-pane { 
            width: 50%; 
            background: #f0f0f0; 
            padding: 20px; 
            overflow-y: auto; 
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* --- LABEL CARD STYLE (4in x 6in) --- */
        .label-card {
            width: 4in;
            height: 6in;
            background: white;
            padding: 0.15in 0.2in; 
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            margin-bottom: 30px;
            flex-shrink: 0;
        }

        /* 1. HEADER section */
        .label-header {
            text-align: center;
            margin-bottom: 5px; 
            border-bottom: 2px solid #eee;
            padding-bottom: 2px;
            height: 0.65in; 
            flex-shrink: 0; 
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .label-header svg { width: 2.2in !important; height: auto; }

        /* 2. BODY section */
        .label-body {
            flex-grow: 1; 
            overflow: hidden; 
            display: flex;
            flex-direction: column;
            padding-top: 10px;
            min-height: 0; 
        }

        /* --- STYLED DATA BLOCKS --- */
        /* Item Name Block */
        .item-block-styled {
            padding: 4px 0;
            margin-bottom: 10px; 
            display: flex;
            align-items: baseline;
            flex-shrink: 0;
        }

        .field-label-styled {
            font-weight: bold;
            margin-right: 8px;
            font-size: 15px; 
            color: #000;
        }

        .item-name-styled {
            font-weight: 900;
            font-size: 16px;
        }
        
        /* Edit Mode Input for Item Name */
        .item-block-styled input[type="text"] {
             font-weight: 900;
             font-size: 16px;
             border: none;
             padding: 0;
             margin: 0;
             background: transparent;
             outline: none;
             width: 100%;
        }
        .item-block-styled input[type="text"]:focus { border-bottom: 1px dotted #ccc; }

        /* Details Block */
        .details-block-styled {
            display: flex;
            flex-direction: column;
            flex-grow: 1; 
            overflow: hidden; 
            margin-bottom: 2px; 
        }

        .details-block-styled .field-label-styled {
            margin-bottom: 4px; 
            display: block;
        }

        .details-content-box {
            padding: 0;
            flex-grow: 1; 
            display: flex;
            flex-direction: column;
            overflow: hidden; 
            position: relative; 
        }

        .details-content-box textarea.edit-details {
            border: none; 
            padding: 0; 
            resize: none;
            width: 100%;
            height: 100%;
            outline: none;
            font-family: inherit;
        }
        
        .details-text { 
            white-space: pre-wrap; 
            font-size: 11px; 
            color: #000; 
            line-height: 1.2;
            display: block;
        }

        /* 3. FOOTER (Tightened Grid) */
        .label-footer-section {
            flex-shrink: 0; 
            border-top: 1px dashed #ccc;
            padding-top: 4px;
            margin-top: 2px;
            display: grid;
            grid-template-columns: 0.6fr 1fr;
            column-gap: 15px;
            row-gap: 2px;
            font-size: 10px; 
            line-height: 1.1;
        }

        .footer-item {
            display: flex;
            align-items: center;
            white-space: nowrap;
            overflow: hidden;
        }
        
        .footer-label { font-weight: bold; margin-right: 4px; color: #444; flex-shrink: 0; }
        .footer-val { font-weight: bold; color: #000; overflow: hidden; text-overflow: ellipsis; }

        /* --- PRINT MEDIA QUERY --- */
        @media print {
            @page { size: 4in 6in; margin: 0; }
            body { background: white; overflow: visible; }
            .app-container { display: none !important; } 
            
            .print-container { 
                display: block !important; 
                width: 100%;
                position: static; 
            }
            
            .label-card {
                box-shadow: none;
                margin: 0;
                page-break-after: always;
                break-inside: avoid;
                border: none;
                float: none;
            }
        }

        .print-container { display: none; }
        
        /* UI Controls Styling */
        .control-panel {
            background: white; padding: 20px; border-radius: 8px;
            margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            width: 4in;
            position: relative;
        }
        
        .clear-btn {
            position: absolute; top: 15px; right: 15px;
            background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5;
            padding: 5px 10px; font-size: 11px; border-radius: 4px; cursor: pointer; font-weight: bold;
        }
        .clear-btn:hover { background: #fecaca; }

        /* General Input Styling */
        input[type="text"] { width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid #ccc; border-radius: 4px; }
        
        .print-btn {
            background: #000; color: white; border: none; padding: 12px 20px;
            font-weight: bold; cursor: pointer; width: 100%; border-radius: 4px; font-size: 16px;
        }
        .print-btn:hover { background: #333; }
        
        textarea.edit-details { width: 100%; height: 100%; font-size: 11px; border: 1px solid #ddd; resize: none; }
    </style>
</head>
<body>

    <div class="app-container">
        <div class="left-pane" id="pdfViewerContainer">
            <div style="color:#ccc; margin-top:50px; text-align:center;">Upload PDF to view here</div>
        </div>

        <div class="right-pane">
            <div class="control-panel">
                <button onclick="clearAll()" class="clear-btn">Reset / Clear</button>
                <h2 style="margin-top:0; margin-bottom:15px; font-size:18px;">SimplyDoors Labels</h2>
                
                <label style="font-size:12px; font-weight:bold; color:#666;">1. UPLOAD PDF</label>
                <input type="file" id="pdfInput" accept=".pdf" style="margin-bottom:15px;">
                
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:5px; margin-bottom:10px;">
                    <input type="text" id="jobIn" placeholder="Job #">
                    <input type="text" id="custIn" placeholder="Customer">
                    <input type="text" id="locIn" placeholder="Location">
                </div>
                
                <div id="statusMsg" style="color:red; font-size:12px; margin:5px 0;"></div>
                
                <button onclick="window.print()" class="print-btn">PRINT LABELS</button>
            </div>

            <h3 style="color:#666; font-size:14px; text-transform:uppercase;">Preview (4" x 6")</h3>
            <div id="previewArea"></div>
        </div>
    </div>

    <div id="printArea" class="print-container"></div>

    <script>
        // --- LOGO SVG DEFINITION ---
        const LOGO = `
        <svg viewBox="0 0 550 100" xmlns="http://www.w3.org/2000/svg">
            <g transform="translate(10,10) scale(0.9)">
                <path fill="#66cc66" d="M10,10 L10,90 L60,80 L60,20 Z" /> 
                <rect x="65" y="10" width="5" height="80" fill="#66cc66" />
                <rect x="10" y="5" width="60" height="5" fill="#66cc66" />
                <circle cx="50" cy="50" r="3" fill="white" />
            </g>
            <text x="80" y="65" font-family="Arial, sans-serif" font-weight="800" font-size="55" fill="#2d3330">SimplyDoors</text>
        </svg>`;

        // --- APP STATE ---
        let items = [];
        
        // --- DOM ELEMENTS ---
        const pdfInput = document.getElementById('pdfInput');
        const pdfViewerContainer = document.getElementById('pdfViewerContainer');
        const previewArea = document.getElementById('previewArea');
        const printArea = document.getElementById('printArea');
        const statusMsg = document.getElementById('statusMsg');
        const jobIn = document.getElementById('jobIn');
        const custIn = document.getElementById('custIn');
        const locIn = document.getElementById('locIn');

        // --- RESET FUNCTION ---
        function clearAll() {
            if(!confirm("Are you sure you want to clear everything?")) return;
            items = [];
            pdfInput.value = '';
            jobIn.value = '';
            custIn.value = '';
            locIn.value = '';
            pdfViewerContainer.innerHTML = '<div style="color:#ccc; margin-top:50px; text-align:center;">Upload PDF to view here</div>';
            statusMsg.innerText = '';
            renderPreview();
            renderPrint();
        }

        // --- PDF UPLOAD HANDLER ---
        pdfInput.addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if(!file) return;

            statusMsg.innerText = "Scanning PDF...";
            pdfViewerContainer.innerHTML = ''; 

            try {
                const buffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({data: buffer}).promise;

                // 1. Render Visual Pages to Left Pane
                for(let i=1; i<=pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const viewport = page.getViewport({scale: 1.0});
                    const canvas = document.createElement('canvas');
                    canvas.className = 'pdf-canvas';
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    const ctx = canvas.getContext('2d');
                    await page.render({canvasContext: ctx, viewport: viewport}).promise;
                    pdfViewerContainer.appendChild(canvas);
                }

                // 2. Extract Global Job Info (from Page 1)
                const p1 = await pdf.getPage(1);
                const txt = await p1.getTextContent();
                const str = txt.items.map(i => i.str).join(" ");
                const getVal = (reg) => (str.match(reg) || [])[1]?.trim() || "";
                
                jobIn.value = getVal(/(?:Job\s*No\.?|InvoiceNo)[:.]?\s*([\w#\/-]+)/i);
                custIn.value = getVal(/(?:Name|Customer)[:]\s*([^,]+)/i);
                locIn.value = getVal(/(?:Location|Address)[:]\s*([^(\n]+)/i);

                // 3. Extract Items (Scan all pages)
                items = [];
                for(let i=1; i<=pdf.numPages; i++) {
                    await scanPage(pdf, i);
                }

                // 4. Handle Results
                if(items.length === 0) {
                    statusMsg.innerText = "No items found. Added manual card.";
                    addManualItem();
                } else {
                    statusMsg.innerText = `Found ${items.length} items.`;
                }
                
                // 5. Initial Render
                renderPreview();
                renderPrint();

            } catch(err) {
                console.error(err);
                statusMsg.innerText = "Error reading PDF. Manual mode.";
                addManualItem();
                renderPreview();
                renderPrint();
            }
        });

        // --- PDF TEXT EXTRACTION LOGIC ---
        async function scanPage(pdf, pageNum) {
            const page = await pdf.getPage(pageNum);
            const content = await page.getTextContent();
            
            // Skip "Terms" pages
            const fullPageText = content.items.map(i => i.str).join(" ").toLowerCase();
            if (fullPageText.includes("terms and conditions") || 
                fullPageText.includes("pre-work signature") ||
                fullPageText.includes("acceptance of terms")) {
                return;
            }

            // Map text items with coordinates
            const rawItems = content.items.map(i => ({ str: i.str, y: i.transform[5], x: i.transform[4] })).sort((a,b) => b.y - a.y);

            // Determine Header (topY) and Footer (botY) boundaries
            let topY = -1, botY = -1;
            rawItems.forEach(i => {
                const s = i.str.toLowerCase().trim();
                if(s === 'description' && topY === -1) topY = i.y;
                if((s.startsWith('materials') || s.includes('total') || s.includes('subtotal')) && botY === -1) {
                    if(topY !== -1 && i.y < topY) botY = i.y;
                }
            });

            if(topY === -1) return;
            if(botY === -1) botY = 50;

            // Group lines by Y-coordinate proximity
            let lines = [];
            let currLine = [];
            let lastY = -999;

            rawItems.filter(i => i.y < (topY - 10) && i.y > (botY + 10)).forEach(i => {
                if(Math.abs(i.y - lastY) > 8) {
                    if(currLine.length) lines.push(currLine.join(" "));
                    currLine = [];
                    lastY = i.y;
                }
                if(i.x < 350) currLine.push(i.str);
            });
            if(currLine.length) lines.push(currLine.join(" "));

            // Parse extracted lines into Item Object
            if(lines.length > 0) {
                let rawName = lines[0];
                let details = lines.slice(1).join("\n").replace(/Product Information:/gi, "").trim();
                
                const cutIndex = details.indexOf("This sale is governed by");
                if (cutIndex !== -1) details = details.substring(0, cutIndex).trim();

                let cleanName = rawName.replace(/Comment\/Room:/gi, "").replace(/Item:/gi, "").trim();
                const match = cleanName.match(/^(.*?)(\d+[-\s]?\d*)$/);
                if (match) cleanName = `${match[2].trim()} ${match[1].trim()}`;

                items.push({ id: Date.now() + Math.random(), name: cleanName, details: details, qty: "1" });
            }
        }

        function addManualItem() {
            items.push({ id: Date.now(), name: "100-1 Item Name", details: "Enter details here...", qty: "1" });
        }

        // --- HTML TEMPLATE GENERATOR ---
        function getCardHTML(item, idx, isEditable, uniqueId) {
             return `
                <div class="label-header">${LOGO}</div>
                
                <div class="label-body" id="body-${uniqueId}">
                    
                    <div class="item-block-styled">
                        <span class="field-label-styled">Item:</span>
                        <div style="flex-grow:1">
                            ${isEditable 
                                ? `<input type="text" value="${item.name}" oninput="updateItem(${idx}, 'name', this.value)">`
                                : `<span class="item-name-styled">${item.name}</span>`
                            }
                        </div>
                    </div>

                    <div class="details-block-styled">
                            <span class="field-label-styled">Details:</span>
                            <div class="details-content-box">
                            ${isEditable
                                ? `<textarea class="edit-details" oninput="updateItem(${idx}, 'details', this.value)">${item.details}</textarea>`
                                : `<span class="details-text" id="text-${uniqueId}">${item.details}</span>`
                            }
                            </div>
                    </div>

                </div>

                <div class="label-footer-section">
                    <div class="footer-item">
                        <span class="footer-label">Qty:</span>
                        ${isEditable
                            ? `<input type="text" value="${item.qty}" oninput="updateItem(${idx}, 'qty', this.value)" style="width:40px; font-weight:bold; font-size:10px;">`
                            : `<span class="footer-val">${item.qty}</span>`
                        }
                    </div>
                    <div class="footer-item">
                        <span class="footer-label">Job:</span>
                        <span class="footer-val">${jobIn.value}</span>
                    </div>
                    <div class="footer-item">
                        <span class="footer-label">Cust:</span>
                        <span class="footer-val">${custIn.value}</span>
                    </div>
                    <div class="footer-item">
                        <span class="footer-label">Loc:</span>
                        <span class="footer-val">${locIn.value}</span>
                    </div>
                </div>
            `;
        }

        // --- RENDER PREVIEW (1 Card per Item) ---
        function renderPreview() {
            previewArea.innerHTML = '';
            items.forEach((item, idx) => {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'label-card';
                cardDiv.innerHTML = getCardHTML(item, idx, true, `preview-${idx}`);
                previewArea.appendChild(cardDiv);
            });
        }

        // --- RENDER PRINT (Duplicate based on Qty) ---
        function renderPrint() {
            printArea.innerHTML = '';
            
            items.forEach((item, idx) => {
                // Parse Qty, default to 1 if invalid
                let count = parseInt(item.qty);
                if(isNaN(count) || count < 1) count = 1;

                // Optimization: Calculate font size on the FIRST copy, apply to rest
                let optimizedStyle = null;

                for(let c = 0; c < count; c++) {
                    const uniqueId = `print-${idx}-${c}`;
                    const printDiv = document.createElement('div');
                    printDiv.className = 'label-card';
                    printDiv.innerHTML = getCardHTML(item, idx, false, uniqueId);
                    printArea.appendChild(printDiv);

                    // If it's the first copy, calculate the shrink fit
                    if(c === 0) {
                        // Append to DOM allows scrollHeight calculation
                        optimizedStyle = calculateFit(uniqueId);
                    } else {
                        // Apply calculated style to duplicates instantly
                        if(optimizedStyle) {
                            const textEl = document.getElementById(`text-${uniqueId}`);
                            if(textEl) {
                                textEl.style.fontSize = optimizedStyle.fontSize + 'px';
                                textEl.style.lineHeight = optimizedStyle.lineHeight;
                            }
                        }
                    }
                }
            });
        }

        // --- SMART SHRINK CALCULATION ---
        function calculateFit(uniqueId) {
            const body = document.getElementById(`body-${uniqueId}`); 
            const textEl = document.getElementById(`text-${uniqueId}`);
            if(!body || !textEl) return null;

            let fontSize = 11; 
            let lineHeight = 1.2;
            textEl.style.fontSize = fontSize + 'px';
            textEl.style.lineHeight = lineHeight;

            // Reduce font size until content fits within the body container
            while ( (body.scrollHeight > body.clientHeight) && fontSize > 6 ) {
                fontSize -= 0.5;
                if(lineHeight > 1.0) lineHeight -= 0.02;
                textEl.style.fontSize = fontSize + 'px';
                textEl.style.lineHeight = lineHeight;
            }
            return { fontSize, lineHeight };
        }

        // --- UPDATE HANDLERS ---
        window.updateItem = (idx, field, val) => {
            items[idx][field] = val;
            
            // If updating Qty, we MUST re-render the Print area to add/remove pages
            if(field === 'qty') {
                renderPrint();
            } else {
                renderPrint();
            }
        };
        
        [jobIn, custIn, locIn].forEach(el => el.addEventListener('input', () => {
            // Re-render both to update header info on all cards
            renderPreview();
            renderPrint();
        }));
    </script>
</body>
</html>
